{
    "collab_server" : "",
    "contents" : "# library(dplyr)\n# library(RMySQL)\nsource('kApiKYCCallsSource.R')\n\n# get.kScoreV2Data <- function(uuidKyc){\n# require(dplyr)\n# if(!is.null(uuidKyc$collectedProfile$scoreV2$kScoreV2$breakdown)){\n#   category <- gsub('\"(.*)\\\\.(.*):.*','\\\\1', uuidKyc$collectedProfile$scoreV2$kScoreV2$breakdown)\n#   ## get between the . and the : \n#   categoryDetail <- gsub(\".*\\\\.(.*):.*\", \"\\\\1\", uuidKyc$collectedProfile$scoreV2$kScoreV2$breakdown)\n#   \n#   ## use as.numberic to convert the +2.0 into positive numbers\n#   kScore <- as.numeric(gsub('(.*):(.*)\\\"',\"\\\\2\",uuidKyc$collectedProfile$scoreV2$kScoreV2$breakdown))\n#   tbl.KScoreV2 <- data_frame(category = category, categoryDetail = categoryDetail, k_score_v2 = kScore)\n#   tbl.KScoreV2$uuid <- uuidKyc$uuid\n#   \n# } else {\n#   tbl.KScoreV2 <- data_frame(category = '', categoryDetail = '', k_score_v2 = 0, uuid = uuidKyc$uuid)\n# }\n# return(tbl.KScoreV2)  \n# }\n\n\nget.users <- function(){\n  require(dplyr)\n  require(RMySQL)\n  con <- dbConnect(MySQL(),dbname = \"kountable\", user = \"kdevdbuser\", \n                   password = \"t00rYFWOiRF\", host = \"prod-db.clv18hnrncxz.us-west-2.rds.amazonaws.com\")\n  userQuery <- \"Select id as uuid from user where status_id=1;\"\n  tbl.users <- con %>% dbGetQuery(userQuery)\n  dbDisconnect(con)\n  return(tbl.users)\n}\nget.kScoreV2Summaries <- function(uuidKyc){\n  require(dplyr)\n  cat(uuidKyc$uuid,'\\n')\n  tbl.KScoreV2 <- data_frame(uuid = uuidKyc$uuid, totalKScore = uuidKyc$collectedProfile$scoreV2$kScoreV2$score,\n                             profileDataScoreV2 = uuidKyc$collectedProfile$scoreV2$profileDataScoreV2$score,\n                             socialMediaAuthScoreV2 = uuidKyc$collectedProfile$scoreV2$socialMediaAuthScoreV2$score,\n                             businessProfileScoreV2 = uuidKyc$collectedProfile$scoreV2$businessProfileScoreV2$score,\n                             documentUploadsScoreV2 = uuidKyc$collectedProfile$scoreV2$documentUploadsScoreV2$score)\n  return(tbl.KScoreV2)  \n}\nget.projectscore <- function(x){\n  tbl.projectscore <- data_frame(projectid=x$uuid,projectscore=x$score)\n  return(tbl.projectscore)\n}\nget.projectscoresuuid <- function(uuid){\n  require(httr)\n  require(dplyr)\n  url <- paste0(\"http://analytics-prod-proxy.cluster.kountable.com:3000/franks/profiles/\",uuid,\"/by-projects\")\n  cat(\"uuid\",uuid,\"\\n\") \n  kscoredata <- GET(url) %>% content(\"parsed\")\n  tbl.projectscoresuuid <- bind_rows(lapply(kscoredata$projectDataScoreV2$projects,get.projectscore)) %>% mutate(uuid=uuid)\n  return(tbl.projectscoresuuid)\n}\n\n\nget.badge1data <- function(tbl.users){\n  require(dplyr)\n  require(RMySQL)\n  users <- get.V2UsersList()\n  ls.api <- lapply(users, get.apiKYCCallNoProfile)\n  profileCutoff <- 0.75*77\n  mediaCutoff <- 0.75*195\n  responsiveCutoff <- 5\n  con <- dbConnect(MySQL(),dbname = \"kountable\", user = \"kdevdbuser\", \n                   password = \"t00rYFWOiRF\", host = \"prod-db.clv18hnrncxz.us-west-2.rds.amazonaws.com\")\n  tbl.BadgeData <- bind_rows(lapply(ls.api, get.kScoreV2Summaries))\n  tbl.BadgeData <- tbl.BadgeData %>% \n    mutate_each_(funs(as.numeric), \"uuid\") %>%\n    mutate(profileCriteria =ifelse(profileDataScoreV2 >= profileCutoff, 1, 0),MediaCriteria =ifelse(socialMediaAuthScoreV2 >= mediaCutoff, 1, 0)) %>% \n    filter(uuid %in% tbl.users$uuid)\n  query <- \"Select id from project where ISNULL(deleted_at) and !(state_id in (3,8)) and state_id<17;\"\n  tbl.projectsNotDelete <- con %>% dbGetQuery(query)\n  query <-\"select c.id,c.entity_id as projectId,c.created_by as uuid,b.user_id as participantuuid \n  from conversation as c,conversation_message as b \n  where c.id=b.conversation_id;\"\n  tbl.conversation <- con %>% dbGetQuery(query) %>% \n    filter(participantuuid!=3810 & (projectId %in% tbl.projectsNotDelete$id)) %>% \n    mutate(response=1,participantuuid=ifelse(participantuuid!=uuid,10001,participantuuid))\n  tbl.conversation <- tbl.conversation %>%\n    group_by(id,projectId,uuid,participantuuid) %>%\n    summarise(responsivefrankKoubel=ifelse(sum(response)>=responsiveCutoff,1,0))\n  tbl.conversation <- tbl.conversation %>%\n    group_by(id,projectId,uuid) %>%\n    summarise(responsiveCriteria=ifelse(sum(responsivefrankKoubel)>=2,1,0))\n  tbl.conversation <- tbl.conversation %>%\n    group_by(uuid) %>%\n    summarise(responsiveCriteria=ifelse(sum(responsiveCriteria)>=1,1,0))\n  tbl.Badgesummary <- tbl.BadgeData %>% left_join(tbl.conversation, by = \"uuid\") %>% \n    mutate(responsiveCriteria=ifelse(is.na(responsiveCriteria),0,responsiveCriteria)) %>% \n    select(uuid,profileCriteria,MediaCriteria,responsiveCriteria)\n  tbl.Badgesummary <- tbl.Badgesummary %>% \n    mutate(badge1=ifelse(profileCriteria==1,ifelse(MediaCriteria==1,ifelse(responsiveCriteria==1,1,0),0),0),\n           one_two=ifelse(profileCriteria==1,ifelse(MediaCriteria==1,1,0),0),\n           one_three=ifelse(profileCriteria==1,ifelse(responsiveCriteria==1,1,0),0),\n           two_three=ifelse(MediaCriteria==1,ifelse(responsiveCriteria==1,1,0),0))\n  dbDisconnect(con)\n  return (tbl.Badgesummary)\n}\nget.badge1summary <- function(tbl.badge_one_data = tbl.badge_one_data){\n  require(dplyr)\n  tbl.Badge_summary <-  tbl.badge_one_data %>% summarise(profileCriteria=sum(profileCriteria),MediaCriteria=sum(MediaCriteria),responsiveCriteria=sum(responsiveCriteria),one_two=sum(one_two),two_three=sum(two_three),one_three=sum(one_three),badge1=sum(badge1))\n  return (tbl.Badge_summary)\n}\nget.badge2data <- function(tbl.users){\n  require(dplyr)\n  require(RMySQL)\n  projectCutoff <- 0.75*65\n  tbl.projectscores <- bind_rows(lapply(tbl.users$uuid,get.projectscoresuuid))\n  con <- dbConnect(MySQL(),dbname = \"kountable\", user = \"kdevdbuser\", \n                   password = \"t00rYFWOiRF\", host = \"prod-db.clv18hnrncxz.us-west-2.rds.amazonaws.com\")\n  query <- \"Select id from project where ISNULL(deleted_at) and !(state_id in (3,8)) and state_id<17;\"\n  tbl.projectsNotDelete <- con %>% dbGetQuery(query)\n  tbl.projectscores <- tbl.projectscores %>% filter(projectscore>=projectCutoff & projectid %in% tbl.projectsNotDelete$id ) %>% group_by(uuid) %>%summarise(projectdataCriteria=1,projectDocumentCriteria=0)\n  tbl.badge_two_data <- tbl.users %>% left_join(tbl.projectscores,by=\"uuid\") %>% mutate(projectdataCriteria=ifelse(is.na(projectdataCriteria),0,projectdataCriteria),projectDocumentCriteria=ifelse(is.na(projectDocumentCriteria),0,projectDocumentCriteria))\n  tbl.badge_two_data <- tbl.badge_two_data %>% mutate(badge2=ifelse(projectdataCriteria+projectDocumentCriteria==2,1,0))\n  dbDisconnect(con)\n  return(tbl.badge_two_data)\n}\nget.badge2summary <- function(tbl.badge_two_data){\n  require(dplyr)\n  tbl.badge_two_summary <- tbl.badge_two_data %>% summarise(projectdataCriteria=sum(projectdataCriteria),projectDocumentCriteria=sum(projectDocumentCriteria),badge2=sum(badge2))\n  return (tbl.badge_two_summary)\n}\nget.badge3data <- function(tbl.users){\n  require(dplyr)\n  require(RMySQL)\n  con <- dbConnect(MySQL(),dbname = \"kountable\", user = \"kdevdbuser\", \n                   password = \"t00rYFWOiRF\", host = \"prod-db.clv18hnrncxz.us-west-2.rds.amazonaws.com\")\n  query <- \"Select p.name as project_name, p.owned_by as uuid, p.state_id from project as p where ISNULL(p.deleted_at);\"\n  tbl.projectStatus <- con %>% dbGetQuery(query) %>%\n    mutate(legalsigned=ifelse(state_id >=17 & state_id < 24,1,0),completed=ifelse(state_id == 24,1,0)) %>%  \n    group_by(uuid) %>%\n    summarise(legalsigned=sum(legalsigned),completed=sum(completed))\n  tbl.dealmaker <- tbl.users %>% left_join(tbl.projectStatus, by = \"uuid\") %>% \n    mutate(legalsigned=ifelse(is.na(legalsigned),0,legalsigned),completed=ifelse(is.na(completed),0,completed))\n  tbl.dealmaker <- tbl.dealmaker %>% \n    mutate(badge3=ifelse(completed>=1 & legalsigned>=1,1,0))\n  dbDisconnect(con)\n  return(tbl.dealmaker)\n}\nget.badge3summary <- function(tbl.badge_three_data){\n  require(dplyr)\n  tbl.dealmaker_summary <- tbl.badge_three_data %>% summarise(legalsigned=sum(legalsigned),completed=sum(completed),badge3=sum(badge3))\n  return (tbl.dealmaker_summary)\n}\n\n\ntbl.users <- get.users()\ntbl.badge_one_data <- get.badge1data(tbl.users)\ntbl.badge_one_summary <- get.badge1summary(tbl.badge_one_data)\ntbl.badge_two_data <- get.badge2data(tbl.users)\ntbl.badge_two_summary <- get.badge2summary(tbl.badge_two_data)\ntbl.badge_three_data <- get.badge3data(tbl.users)\ntbl.badge_three_summary <- get.badge3summary(tbl.badge_three_data)\n\n\n\n",
    "created" : 1482161408752.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "23|24|32|0|\n33|43|42|0|\n43|32|46|0|\n47|40|55|0|\n58|38|100|0|\n101|71|105|0|\n106|38|120|0|\n121|50|125|0|\n126|38|142|0|\n143|52|147|0|\n",
    "hash" : "953886209",
    "id" : "6B916B88",
    "lastKnownWriteTime" : 1484860042,
    "last_content_update" : 1484860042061,
    "path" : "~/Downloads/Badges/Get_data.R",
    "project_path" : "Get_data.R",
    "properties" : {
        "docOutlineVisible" : "0"
    },
    "relative_order" : 1,
    "source_on_save" : true,
    "source_window" : "",
    "type" : "r_source"
}