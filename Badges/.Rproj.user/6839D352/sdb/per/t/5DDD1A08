{
    "collab_server" : "",
    "contents" : "# library(dplyr)\n# library(RMySQL)\n\nget.users <- function(){\n  require(dplyr)\n  require(RMySQL)\n  con <- dbConnect(MySQL(),dbname = \"kountable\", user = \"kdevdbuser\", \n                   password = \"t00rYFWOiRF\", host = \"prod-db.clv18hnrncxz.us-west-2.rds.amazonaws.com\")\n  userQuery <- \"Select id as uuid from user where status_id=1;\"\n  tbl.users <- con %>% dbGetQuery(userQuery)\n  dbDisconnect(con)\n  return(tbl.users)\n}\nget.kdatauuid <- function(uuid){\n  require(httr)\n  require(dplyr)\n    url <- paste0(\"http://analytics-prod-proxy.cluster.kountable.com:3000/franks/profiles/\",uuid,\"/by-projects\")\n    cat(\"uuid\",uuid,\"\\n\") \n    kdatauuid <- GET(url) %>% content(\"parsed\")\n    i=0\n  if(is.null(kdatauuid$uuid) & i<2){\n    url <- paste0(\"http://analytics-prod-proxy.cluster.kountable.com:3000/franks/profiles/\",uuid,\"/by-projects\")\n    cat(\"uuid\",uuid,\"\\n\") \n    kdatauuid <- GET(url) %>% content(\"parsed\")\n    i=i+1;\n  }\n  return(kdatauuid)\n}\nget.kscoredata <- function(){\n  allUsers <- get.V2UsersList()\n  names(allUsers) <- allUsers\n  kscoredata <- lapply(allUsers, function(x) get.kdatauuid(x))\n  return(kscoredata)\n}\nget.personaldata <- function(frankdata){\n  cat(frankdata$uuid,\"\\n\")\n  tbl.personaldata <- data_frame(uuid = frankdata$uuid,\n                                 profileCriteria = ifelse(is.null(frankdata$profileDataScoreV2$score),0,as.numeric(frankdata$profileDataScoreV2$score)),\n                                 facebook = ifelse(is.null(frankdata$socialMediaAuthScoreV2$facebook$score),0,as.numeric(frankdata$socialMediaAuthScoreV2$facebook$score)),\n                                 linkedin = ifelse(is.null(frankdata$socialMediaAuthScoreV2$linkedin$score),0,as.numeric(frankdata$socialMediaAuthScoreV2$linkedin$score)),\n                                 yahoo = ifelse(is.null(frankdata$socialMediaAuthScoreV2$yahoo$score),0,as.numeric(frankdata$socialMediaAuthScoreV2$yahoo$score)),\n                                 googleplus = ifelse(is.null(frankdata$socialMediaAuthScoreV2$googleplus$score),0,as.numeric(frankdata$socialMediaAuthScoreV2$googleplus$score)),\n                                 twitter = ifelse(is.null(frankdata$socialMediaAuthScoreV2$twitter$score),0,as.numeric(frankdata$socialMediaAuthScoreV2$twitter$score))\n  )\n  return(tbl.personaldata)  \n}\nget.projectscore <- function(x){\n  tbl.projectscore <- data_frame(projectid=x$uuid,projectscore=x$score)\n  return(tbl.projectscore)\n}\nget.projectscoresuuid <- function(frankdata){\n  tbl.projectscoresuuid <- bind_rows(lapply(frankdata$projectScoreV2$projects,function(x){\n    tbl.projectscore <- data_frame(projectid=x$uuid,projectscore=x$projectDataScore$score,projectdocscore=x$projectDocumentsScore$score)\n    return(tbl.projectscore)\n  }))\n  tbl.projectscoresuuid <- tbl.projectscoresuuid %>% mutate(uuid=as.numeric(frankdata$uuid))\n  return(tbl.projectscoresuuid)\n}\n\n\nget.badge1data <- function(tbl.users,kscoredata){\n  require(dplyr)\n  require(RMySQL)\n  fprofilecutoff <- 0.5*39\n  profileCutoff <- 0.5*77\n  mediaCutoff <- 0.5*195\n  responsiveCutoff <- 1\n  facebookcutoff <- 0.5*26\n  linkedincutoff <- 0.5*35\n  twittercutoff <- 0.5*33\n  yahoocutoff <- 0.5*21\n  googlepluscutoff <- 0.5*36\n  socialmediaacesscutoff <- 1\n  tbl.personaldata <- bind_rows(lapply(kscoredata,function(frankdata) get.personaldata(frankdata)))\n  tbl.personaldata <- tbl.personaldata %>% mutate(uuid=as.numeric(uuid)) %>% filter(uuid %in% tbl.users$uuid) %>%\n    mutate(facebook=ifelse(facebook>=facebookcutoff,1,0),\n           linkedin=ifelse(linkedin>=linkedincutoff,1,0),\n           googleplus=ifelse(googleplus>=googlepluscutoff,1,0),\n           twitter=ifelse(twitter>=twittercutoff,1,0),\n           yahoo=ifelse(yahoo>=yahoocutoff,1,0),\n           mediaCriteria=ifelse((facebook+googleplus+twitter+linkedin+yahoo)>=socialmediaacesscutoff,1,0),\n           profileCriteria =ifelse(profileCriteria >= profileCutoff, 1, 0))\n  con <- dbConnect(MySQL(),dbname = \"kountable\", user = \"kdevdbuser\", \n                   password = \"t00rYFWOiRF\", host = \"prod-db.clv18hnrncxz.us-west-2.rds.amazonaws.com\")\n  query <- \"Select id from project where ISNULL(deleted_at) and !(state_id in (3,8)) and state_id<17;\"\n  tbl.projectsNotDelete <- con %>% dbGetQuery(query)\n  query <-\"select c.id,c.entity_id as projectId,c.created_by as uuid,b.user_id as participantuuid \n  from conversation as c,conversation_message as b \n  where c.id=b.conversation_id;\"\n  tbl.conversation <- con %>% dbGetQuery(query) %>% \n    filter(participantuuid!=3810 & (projectId %in% tbl.projectsNotDelete$id)) %>% \n    mutate(response=1,participantuuid=ifelse(participantuuid!=uuid,10001,participantuuid))\n  tbl.conversation <- tbl.conversation %>%\n    group_by(id,projectId,uuid,participantuuid) %>%\n    summarise(responsivefrankKoubel=ifelse(sum(response)>=responsiveCutoff,1,0))\n  tbl.conversation <- tbl.conversation %>%\n    group_by(id,projectId,uuid) %>%\n    summarise(responsiveCriteria=ifelse(sum(responsivefrankKoubel)>=2,1,0))\n  tbl.conversation <- tbl.conversation %>%\n    group_by(uuid) %>%\n    summarise(responsiveCriteria=ifelse(sum(responsiveCriteria)>=1,1,0))\n  tbl.personaldata <- tbl.personaldata %>% left_join(tbl.conversation, by = \"uuid\") %>% \n    mutate(responsiveCriteria=ifelse(is.na(responsiveCriteria),0,responsiveCriteria)) %>% \n    select(uuid,profileCriteria,mediaCriteria,responsiveCriteria)\n  tbl.frankeditprofiledata <- get.frankeditprofiledata() %>% mutate(frank_filled_profile=ifelse(totalscore>=fprofilecutoff,1,0)) %>% select(uuid,frank_filled_profile)\n  tbl.personaldata <- tbl.personaldata %>% left_join(tbl.frankeditprofiledata,by='uuid')\n  tbl.personaldata <- tbl.personaldata %>% \n    mutate(badge1=ifelse(frank_filled_profile==1,ifelse(mediaCriteria==1,ifelse(responsiveCriteria==1,1,0),0),0),\n           one_two=ifelse(frank_filled_profile==1,ifelse(mediaCriteria==1,1,0),0),\n           one_three=ifelse(frank_filled_profile==1,ifelse(responsiveCriteria==1,1,0),0),\n           two_three=ifelse(mediaCriteria==1,ifelse(responsiveCriteria==1,1,0),0))\n  dbDisconnect(con)\n  tbl.personaldata <- tbl.personaldata %>% select(uuid,frank_filled_profile,mediaCriteria,responsiveCriteria,one_two,two_three, one_three,badge1)\n  return (tbl.personaldata)\n}\nget.badge1summary <- function(tbl.badge_one_data){\n  require(dplyr)\n  tbl.Badge_summary <-  tbl.badge_one_data %>% summarise(frank_filled_profile=sum(frank_filled_profile),mediaCriteria=sum(mediaCriteria),responsiveCriteria=sum(responsiveCriteria),one_two=sum(one_two),two_three=sum(two_three),one_three=sum(one_three),badge1=sum(badge1))\n  return (tbl.Badge_summary)\n}\nget.badge2data <- function(tbl.users,kscoredata){\n  require(dplyr)\n  require(RMySQL)\n  projectCutoff <- 0.5*65\n  maxdocscore <- 0.5*20\n  tbl.projectdata <- bind_rows(lapply(kscoredata,function(frankdata) get.projectscoresuuid(frankdata)))\n  tbl.projectdata <- tbl.projectdata %>% filter(uuid %in% tbl.users$uuid)\n  con <- dbConnect(MySQL(),dbname = \"kountable\", user = \"kdevdbuser\", \n                   password = \"t00rYFWOiRF\", host = \"prod-db.clv18hnrncxz.us-west-2.rds.amazonaws.com\")\n  query <- \"Select id from project where ISNULL(deleted_at) and !(state_id in (3,8)) and state_id<17;\"\n  tbl.projectsNotDelete <- con %>% dbGetQuery(query)\n  tbl.projectdata <- tbl.projectdata%>% filter(projectid %in% tbl.projectsNotDelete$id) %>%\n    mutate(projectDataCriteria=ifelse(projectscore>=projectCutoff,1,0),projectDocumentCriteria=ifelse(projectdocscore==20,1,0),Badge2=ifelse(projectDataCriteria+projectDocumentCriteria==2,1,0)) %>%\n    group_by(uuid) %>%summarise(projectDataCriteria=ifelse(sum(projectDataCriteria)>=1,1,0),projectDocumentCriteria=ifelse(sum(projectDocumentCriteria)>=1,1,0),Badge2=ifelse(sum(Badge2)>=1,1,0))\n  tbl.badge_two_data <- tbl.users %>% left_join(tbl.projectdata, by=\"uuid\") %>% mutate(projectDataCriteria=ifelse(is.na(projectDataCriteria),0,projectDataCriteria),projectDocumentCriteria=ifelse(is.na(projectDocumentCriteria),0,projectDocumentCriteria),Badge2=ifelse(is.na(Badge2),0,Badge2))\n  dbDisconnect(con)\n  return(tbl.badge_two_data)\n}\nget.badge2summary <- function(tbl.badge_two_data){\n  require(dplyr)\n  tbl.badge_two_summary <- tbl.badge_two_data %>% summarise(projectDataCriteria=sum(projectDataCriteria),projectDocumentCriteria=sum(projectDocumentCriteria),Badge2=sum(Badge2))\n  return (tbl.badge_two_summary)\n}\nget.badge3data <- function(tbl.users){\n  require(dplyr)\n  require(RMySQL)\n  con <- dbConnect(MySQL(),dbname = \"kountable\", user = \"kdevdbuser\", \n                   password = \"t00rYFWOiRF\", host = \"prod-db.clv18hnrncxz.us-west-2.rds.amazonaws.com\")\n  query <- \"Select p.name as project_name, p.owned_by as uuid, p.state_id from project as p where ISNULL(p.deleted_at);\"\n  tbl.projectStatus <- con %>% dbGetQuery(query) %>%\n    mutate(legalsigned=ifelse(state_id >=17 & state_id < 24,1,0),completed=ifelse(state_id == 24,1,0)) %>%  \n    group_by(uuid) %>%\n    summarise(legalsigned=sum(legalsigned),completed=sum(completed))\n  tbl.dealmaker <- tbl.users %>% left_join(tbl.projectStatus, by = \"uuid\") %>% \n    mutate(legalsigned=ifelse(is.na(legalsigned),0,legalsigned),completed=ifelse(is.na(completed),0,completed))\n  tbl.dealmaker <- tbl.dealmaker %>% \n    mutate(badge3=ifelse(completed>=1 & legalsigned>=1,1,0))\n  dbDisconnect(con)\n  return(tbl.dealmaker)\n}\nget.badge3summary <- function(tbl.badge_three_data){\n  require(dplyr)\n  tbl.dealmaker_summary <- tbl.badge_three_data %>% summarise(legalsigned=sum(legalsigned),completed=sum(completed),badge3=sum(badge3))\n  return (tbl.dealmaker_summary)\n}\nget.frankeditprofiledata <- function(){\n  require(dplyr)\n  require(RMySQL)\n  con <- dbConnect(MySQL(),dbname = \"kountable\", user = \"kdevdbuser\", \n                   password = \"t00rYFWOiRF\", host = \"prod-db.clv18hnrncxz.us-west-2.rds.amazonaws.com\")\n  userQuery <- \"Select id as uuid,first_name,last_name,email_verified,phone_verified,country_id as country,skype,address,state,city,postal_code from user where status_id=1;\"\n  tbl.profile <- con %>% dbGetQuery(userQuery)\n  tbl.profile <- tbl.profile %>% mutate(first_name=ifelse(first_name=='',0,2),last_name=ifelse(last_name=='',0,2),skype=ifelse(skype=='',0,2),\n                                        country =ifelse(country==0,0,2),email_verified=ifelse(email_verified==0,0,10),\n                                        phone_verified=ifelse(phone_verified==0,0,10),\n                                        address=ifelse(address=='',0,5),city=ifelse(city=='',0,2),postal_code=ifelse(postal_code=='',0,2),\n                                        state=ifelse(state=='',0,2),\n                                        totalscore=first_name+last_name+skype+email_verified+phone_verified+country+address+city+postal_code+state)\n  dbDisconnect(con)\n  return(tbl.profile)\n}\n\ntbl.users <- get.users()\nkscoredata <- get.kscoredata()\ntbl.badge_one_data <- get.badge1data(tbl.users,kscoredata)\ntbl.badge_one_summary <- get.badge1summary(tbl.badge_one_data)\ntbl.badge_two_data <- get.badge2data(tbl.users,kscoredata)\ntbl.badge_two_summary <- get.badge2summary(tbl.badge_two_data)\ntbl.badge_three_data <- get.badge3data(tbl.users)\ntbl.badge_three_summary <- get.badge3summary(tbl.badge_three_data)\n\n",
    "created" : 1487366933039.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "3|24|12|0|\n13|32|27|0|\n34|40|45|0|\n46|32|49|0|\n50|45|57|0|\n115|50|119|0|\n120|49|137|0|\n138|50|142|0|\n143|38|159|0|\n160|52|164|0|\n165|39|180|0|\n",
    "hash" : "4021485877",
    "id" : "5DDD1A08",
    "lastKnownWriteTime" : 1488822141,
    "last_content_update" : 1488907887348,
    "path" : "~/Rproject/Badges/Get_data.R",
    "project_path" : "Get_data.R",
    "properties" : {
        "docOutlineVisible" : "1"
    },
    "relative_order" : 5,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}